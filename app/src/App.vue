<!-- eslint-disable global-require -->
<template>
  <v-app id="inspire" :class="`brand-${appConfig.id}`">
    <router-view />
    <cookie-law @accept="acceptCookies">
      <div slot-scope="props" style="width: 100%;">
        <div class="d-flex align-center justify-center mb-5">
          <small class="mb-0">
            We use cookies which are essential for you to access our website and/or
            to provide you with our services
            and allow us to measure and improve the
            performance of our website. <br v-if="$vuetify.breakpoint.xsOnly" />
            <a href="/privacy" target="_blank">Learn more</a>.
          </small>
        </div>
        <div class="text-center">
          <v-btn
            color="primary"
            :block="$vuetify.breakpoint.xsOnly"
            :class="$vuetify.breakpoint.smAndUp ? 'mr-5' : 'mb-5'"
            @click="props.accept"
          >
            <v-icon left>mdi-checkbox-marked-circle-outline</v-icon>
            Accept all cookies
          </v-btn>
          <v-btn
            color="primary"
            outlined
            :block="$vuetify.breakpoint.xsOnly"
            @click="props.close"
          >
            <v-icon left>mdi-cancel</v-icon>
            Accept essential only
          </v-btn>
        </div>
      </div>
    </cookie-law>
    <v-tour name="introTour" :steps="steps">
      <template slot-scope="tour">
        <transition name="fade">
          <v-step
            v-for="(step, index) of tour.steps"
            :key="index"
            v-if="tour.currentStep === index"
            :step="step"
            :previous-step="tour.previousStep"
            :next-step="tour.nextStep"
            :stop="tour.stop"
            :skip="tour.skip"
            :is-first="tour.isFirst"
            :is-last="tour.isLast"
            :labels="tour.labels"
            :highlight="tour.highlight"
          >
            <template>
              <div slot="actions">
                <v-btn v-if="tour.currentStep > 0" @click="tour.previousStep" small outlined dark class="mr-2">Previous step</v-btn>
                <v-btn @click="tour.nextStep" small color="white">Next step</v-btn>
              </div>
            </template>
          </v-step>
        </transition>
      </template>
    </v-tour>
  </v-app>
</template>

<script>
// Utilities
import {
  mapState,
  mapGetters,
} from 'vuex';
import CookieLaw from 'vue-cookie-law';

export default {
  components: {
    CookieLaw,
  },
  data: () => ({
    showPrivacyDialog: false,
    steps: [
      {
        target: '#v-step-0',
        header: {
          title: 'POI filters',
        },
        content: `Filter the displayed points of interest (POI) by country. Try clicking on a country from the list below!`,
        params: {
          highlight: true,
        }
      },
      {
        target: '#v-step-1',
        header: {
          title: 'POI filters',
        },
        content: 'You can also filter by indicator. Click on the indicators tab to see all available indicators. There might be combinations of country & indicator that have no filter results, so adjust accorddingly.',
      },
      {
        target: '#v-step-2',
        header: {
          title: 'Global indicatos',
        },
        content: 'In the map view, this is the place to find global indicators that span all countries. Click on this button to show available indicators.',
        params: {
          placement: 'right'
        }
      },
      {
        target: '#v-step-3',
        header: {
          title: 'Table view',
        },
        content: 'If you would like to browse the available POIs via a table view instead of a map view, click this tab.',
        params: {
          placement: 'bottom'
        }
      },
      {
        target: '#v-step-4',
        header: {
          title: 'POI details',
        },
        content: `Click on one of the POIs to see its details`,
        params: {
          placement: 'top'
        }
      },
      {
        target: '#v-step-5',
        header: {
          title: 'POI details',
        },
        content: `Click on one of the POIs to see its details`,
        params: {
          placement: 'left'
        }
      },
    ],
  }),
  computed: {
    ...mapState('config', ['appConfig']),
    ...mapGetters('features', [
      'getIndicators',
      'getCountryItems',
    ]),
  },
  mounted() {
    // Listen for features added, and select if poi in query
    this.$store.subscribe((mutation) => {
      if (mutation.type === 'features/ADD_NEW_FEATURES') {
        // Read route query and set selected poi
        const { poi } = this.$route.query;
        let selectedFeature = null;
        if (poi && poi.includes('-')) {
          const aoiId = poi.split('-')[0];
          const indicatorCode = poi.split('-')[1];
          selectedFeature = this.$store.state.features.allFeatures.find((f) => {
            const { indicatorObject } = f.properties;
            return indicatorObject.AOI_ID === aoiId
              && indicatorObject['Indicator code'] === indicatorCode;
          });
        }
        this.$store.commit('indicators/SET_SELECTED_INDICATOR', selectedFeature ? selectedFeature.properties.indicatorObject : null);

        // Read route query and validate country and indicator if in query
        const { country } = this.$route.query;
        const { indicator } = this.$route.query;
        // validate query for country - need to be among available
        const selectedCountry = this.getCountryItems
          .map((item) => item.code).find((f) => f === country);
        const selectedIndicator = this.getIndicators
          .map((item) => item.code).find((f) => f === indicator);
        this.$store.commit('features/INIT_FEATURE_FILTER', {
          countries: selectedCountry,
          indicators: selectedIndicator,
        });
      }

      // Url query replacement
      if (mutation.type === 'features/SET_FEATURE_FILTER') {
        if (Array.isArray(mutation.payload.countries) && mutation.payload.countries.length === 0) {
          // Global
          const query = Object.assign({}, this.$route.query); // eslint-disable-line
          delete query.country;
          this.$router.replace({ query }).catch(err => {}); // eslint-disable-line
          this.trackEvent('filters', 'select_country_filter', 'Global');
        } else if (typeof mutation.payload.countries === 'string') {
          // Country
          this.$router.replace({ query: Object.assign({}, this.$route.query, { country: mutation.payload.countries }) }).catch(err => {}); // eslint-disable-line
          this.trackEvent('filters', 'select_country_filter', mutation.payload.countries);
        }
        if (Array.isArray(mutation.payload.indicators)) {
          if (mutation.payload.indicators.length === 0) {
            // Reset
            const query = Object.assign({}, this.$route.query); // eslint-disable-line
            delete query.indicator;
            this.$router.replace({ query }).catch(err => {}); // eslint-disable-line
            this.trackEvent('filters', 'select_indicator_filter', 'all');
          } else {
            // Single
            this.$router.replace({ query: Object.assign({}, this.$route.query, { indicator: mutation.payload.indicators[0] }) }).catch(err => {}); // eslint-disable-line
            this.trackEvent('filters', 'select_indicator_filter', mutation.payload.indicators[0]);
          }
        }
      }

      if (mutation.type === 'indicators/SET_SELECTED_INDICATOR') {
        if (mutation.payload) {
          this.$router.replace({ query: Object.assign({}, this.$route.query, { poi: `${mutation.payload.AOI_ID}-${mutation.payload['Indicator code']}` }) }).catch(err => {}); // eslint-disable-line
          this.trackEvent('indicators', 'select_indicator', `${mutation.payload.AOI_ID}-${mutation.payload['Indicator code']}`);
        } else {
          const query = Object.assign({}, this.$route.query); // eslint-disable-line
          delete query.poi;
          this.$router.replace({ query }).catch(err => {}); // eslint-disable-line
          this.trackEvent('indicators', 'deselect_indicator');
        }
      }
    });
  },
  methods: {
    acceptCookies() {
      if (this.$matomo) {
        this.$matomo.rememberConsentGiven();
      }
    },
  },
};
</script>

<style lang="scss">
@import "~@/scss/global.scss";

// .v-tour {
//   .v-step__header, .v-step {
//     background: var(--v-primary-base) !important;
//   }
//   .v-step .v-step__arrow, .v-step .v-step__arrow--dark {
//     border-color: var(--v-primary-base) !important;
//   }
  ::v-deep .v-tour__target--highlighted {
    box-shadow: 0 0 0 99999px rgba(0,0,0,.4);
  }
// }
</style>
